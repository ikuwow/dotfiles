#!/usr/bin/env bash
set -euo pipefail

# git diffの出力を取得（ステージング済みの変更を優先、なければ未ステージングの変更）
DIFF=$(git diff --staged)
if [ -z "$DIFF" ]; then
    DIFF=$(git diff)
fi

# 変更がない場合は終了
if [ -z "$DIFF" ]; then
    echo "変更がないで。コミットするもんがないわ。" >&2
    exit 1
fi

# codex execでコミットメッセージを生成
echo "コミットメッセージ生成中..." >&2
PROMPT="Generate an appropriate commit message based on the git diff output below.
Do NOT execute the git diff command.
Format: \"verb: description\" in a single concise line.
Output ONLY the commit message in English, without any additional explanation or text.

--- git diff output ---
$DIFF
--- end of diff ---"

COMMIT_MSG=$(echo "$PROMPT" | codex exec -)

# 生成されたメッセージを表示
echo "生成されたコミットメッセージ:" >&2
echo "$COMMIT_MSG" >&2
echo "" >&2

# ステージングされていない変更がある場合は全てステージング
if [ -z "$(git diff --staged)" ]; then
    git add -A
fi

# 一時ファイルにコミットメッセージを保存してエディターで開く
TEMP_MSG=$(mktemp)
echo "$COMMIT_MSG" > "$TEMP_MSG"

# コミット実行（エディターが開く）
git commit -t "$TEMP_MSG"

# 一時ファイルを削除
rm -f "$TEMP_MSG"

echo "コミット完了や！" >&2
